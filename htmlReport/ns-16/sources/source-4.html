


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > DesugarState</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.iguana.grammar.transformation</a>
</div>

<h1>Coverage Summary for Class: DesugarState (org.iguana.grammar.transformation)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DesugarState</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (109/109)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DesugarState$DesugarStateVisitor</td>
<td class="coverageStat">
  <span class="percent">
    28.6%
  </span>
  <span class="absValue">
    (6/21)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    62.5%
  </span>
  <span class="absValue">
    (45/72)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    37.5%
  </span>
  <span class="absValue">
    (9/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    85.1%
  </span>
  <span class="absValue">
    (154/181)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright (c) 2015, Ali Afroozeh and Anastasia Izmaylova, Centrum Wiskunde &amp; Informatica (CWI)
&nbsp; * All rights reserved.
&nbsp; *
&nbsp; * Redistribution and use in source and binary forms, with or without
&nbsp; * modification, are permitted provided that the following conditions are met:
&nbsp; *
&nbsp; * 1. Redistributions of source code must retain the above copyright notice, this
&nbsp; *    list of conditions and the following disclaimer.
&nbsp; *
&nbsp; * 2. Redistributions in binary form must reproduce the above copyright notice, this
&nbsp; *    list of conditions and the following disclaimer in the documentation and/or
&nbsp; *    other materials provided with the distribution.
&nbsp; *
&nbsp; * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
&nbsp; * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
&nbsp; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
&nbsp; * IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
&nbsp; * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
&nbsp; * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
&nbsp; * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
&nbsp; * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
&nbsp; * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY
&nbsp; * OF SUCH DAMAGE.
&nbsp; *
&nbsp; */
&nbsp;
&nbsp;package org.iguana.grammar.transformation;
&nbsp;
&nbsp;import org.iguana.datadependent.ast.AST;
&nbsp;import org.iguana.datadependent.ast.Expression;
&nbsp;import org.iguana.datadependent.traversal.FreeVariableVisitor;
&nbsp;import org.iguana.grammar.exception.UnexpectedSymbolException;
&nbsp;import org.iguana.grammar.operations.ReachabilityGraph;
&nbsp;import org.iguana.grammar.runtime.RuntimeGrammar;
&nbsp;import org.iguana.grammar.runtime.RuntimeRule;
&nbsp;import org.iguana.grammar.symbol.Align;
&nbsp;import org.iguana.grammar.symbol.Alt;
&nbsp;import org.iguana.grammar.symbol.Block;
&nbsp;import org.iguana.grammar.symbol.Code;
&nbsp;import org.iguana.grammar.symbol.Conditional;
&nbsp;import org.iguana.grammar.symbol.Error;
&nbsp;import org.iguana.grammar.symbol.Group;
&nbsp;import org.iguana.grammar.symbol.IfThen;
&nbsp;import org.iguana.grammar.symbol.IfThenElse;
&nbsp;import org.iguana.grammar.symbol.Ignore;
&nbsp;import org.iguana.grammar.symbol.Nonterminal;
&nbsp;import org.iguana.grammar.symbol.Nonterminal.Builder;
&nbsp;import org.iguana.grammar.symbol.Offside;
&nbsp;import org.iguana.grammar.symbol.Opt;
&nbsp;import org.iguana.grammar.symbol.Plus;
&nbsp;import org.iguana.grammar.symbol.Return;
&nbsp;import org.iguana.grammar.symbol.Star;
&nbsp;import org.iguana.grammar.symbol.Start;
&nbsp;import org.iguana.grammar.symbol.Symbol;
&nbsp;import org.iguana.grammar.symbol.Terminal;
&nbsp;import org.iguana.grammar.symbol.While;
&nbsp;import org.iguana.traversal.ISymbolVisitor;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.LinkedHashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Set;
&nbsp;
&nbsp;import static org.iguana.utils.string.StringUtil.listToString;
&nbsp;
&nbsp;/**
&nbsp; * @author Anastasia Izmaylova
&nbsp; */
&nbsp;
&nbsp;/*
&nbsp; * phase: after EBNF transformation
&nbsp; */
<b class="fc">&nbsp;public class DesugarState implements GrammarTransformation {</b>
&nbsp;
<b class="fc">&nbsp;    private final Map&lt;Nonterminal, Set&lt;String&gt;&gt; uses = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;    private final Map&lt;Nonterminal, Set&lt;String&gt;&gt; updates = new HashMap&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;    private final Map&lt;Nonterminal, Set&lt;String&gt;&gt; returns = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;    private final Map&lt;Nonterminal, List&lt;Map&lt;Nonterminal, Set&lt;String&gt;&gt;&gt;&gt; bindings = new HashMap&lt;&gt;();</b>
&nbsp;    private RuntimeGrammar grammar;
&nbsp;
&nbsp;    @Override
&nbsp;    public RuntimeGrammar transform(RuntimeGrammar grammar) {
<b class="fc">&nbsp;        this.grammar = grammar;</b>
&nbsp;        Set&lt;String&gt; current_uses;
&nbsp;        Set&lt;String&gt; current_updates;
<b class="fc">&nbsp;        for (Nonterminal head : grammar.getNonterminals()) {</b>
&nbsp;
<b class="fc">&nbsp;            current_uses = new HashSet&lt;&gt;();</b>
<b class="fc">&nbsp;            current_updates = new HashSet&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;            uses.put(head, current_uses);</b>
<b class="fc">&nbsp;            updates.put(head, current_updates);</b>
&nbsp;
<b class="fc">&nbsp;            FreeVariableVisitor visitor = new FreeVariableVisitor(current_uses, current_updates);</b>
&nbsp;
<b class="fc">&nbsp;            for (RuntimeRule rule : grammar.getAlternatives(head))</b>
<b class="fc">&nbsp;                visitor.compute(rule);</b>
&nbsp;
<b class="fc">&nbsp;            if (!current_updates.isEmpty()) System.out.println(</b>
<b class="fc">&nbsp;                    &quot;Updates: &quot; + head + &quot;    &quot; + listToString(current_updates, &quot; , &quot;));</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="fc">&nbsp;        Map&lt;Nonterminal, Set&lt;Nonterminal&gt;&gt; reachabilityGraph = new ReachabilityGraph(grammar).getReachabilityGraph();</b>
<b class="fc">&nbsp;        for (Map.Entry&lt;Nonterminal, Set&lt;Nonterminal&gt;&gt; entry : reachabilityGraph.entrySet()) {</b>
<b class="fc">&nbsp;            current_uses = uses.get(entry.getKey());</b>
<b class="fc">&nbsp;            current_updates = updates.get(entry.getKey());</b>
&nbsp;
<b class="fc">&nbsp;            for (Nonterminal nonterminal : entry.getValue()) {</b>
<b class="fc">&nbsp;                current_uses.addAll(uses.get(nonterminal));</b>
<b class="fc">&nbsp;                current_updates.addAll(updates.get(nonterminal));</b>
<b class="fc">&nbsp;            }</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
&nbsp;        // Compute returns
<b class="fc">&nbsp;        for (Nonterminal nonterminal : updates.keySet())</b>
<b class="fc">&nbsp;            returns.put(nonterminal, new HashSet&lt;&gt;());</b>
&nbsp;
<b class="fc">&nbsp;        for (Nonterminal head : grammar.getNonterminals()) {</b>
<b class="fc">&nbsp;            FreeVariableVisitor visitor = new FreeVariableVisitor(uses, updates, returns);</b>
&nbsp;
<b class="fc">&nbsp;            List&lt;Map&lt;Nonterminal, Set&lt;String&gt;&gt;&gt; nonterminal_bindings = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;            bindings.put(head, nonterminal_bindings);</b>
&nbsp;
<b class="fc">&nbsp;            for (RuntimeRule rule : grammar.getAlternatives(head))</b>
<b class="fc">&nbsp;                nonterminal_bindings.add(visitor.computeBindings(rule));</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="fc">&nbsp;        boolean changed = true;</b>
<b class="fc">&nbsp;        while (changed) {</b>
<b class="fc">&nbsp;            changed = false;</b>
<b class="fc">&nbsp;            for (Map.Entry&lt;Nonterminal, Set&lt;String&gt;&gt; head : returns.entrySet()) {</b>
<b class="fc">&nbsp;                if (!head.getValue().isEmpty()) {</b>
<b class="fc">&nbsp;                    for (Map&lt;Nonterminal, Set&lt;String&gt;&gt; rule_bindings : bindings.get(head.getKey())) {</b>
<b class="fc">&nbsp;                        for (Map.Entry&lt;Nonterminal, Set&lt;String&gt;&gt; in_rule_bindings : rule_bindings.entrySet()) {</b>
<b class="fc">&nbsp;                            Set&lt;String&gt; nonterminal_updates = updates.get(in_rule_bindings.getKey());</b>
<b class="fc">&nbsp;                            Set&lt;String&gt; nonterminal_returns = returns.get(in_rule_bindings.getKey());</b>
<b class="fc">&nbsp;                            for (String ret : head.getValue()) {</b>
<b class="fc">&nbsp;                                if (nonterminal_updates.contains(ret) &amp;&amp; !in_rule_bindings.getValue().contains(ret)) {</b>
<b class="fc">&nbsp;                                    in_rule_bindings.getValue().add(ret);</b>
<b class="fc">&nbsp;                                    if (!nonterminal_returns.contains(ret)) {</b>
<b class="fc">&nbsp;                                        nonterminal_returns.add(ret);</b>
<b class="fc">&nbsp;                                        changed = true;</b>
&nbsp;                                    }
&nbsp;                                }
<b class="fc">&nbsp;                            }</b>
<b class="fc">&nbsp;                        }</b>
<b class="fc">&nbsp;                    }</b>
&nbsp;                }
<b class="fc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        for (Map.Entry&lt;Nonterminal, Set&lt;String&gt;&gt; entry : uses.entrySet())</b>
<b class="fc">&nbsp;            if (!entry.getValue().isEmpty()) {</b>
<b class="fc">&nbsp;                System.out.println(&quot;Uses: &quot; + entry.getKey() + &quot;    &quot; + listToString(entry.getValue(), &quot;;&quot;));</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;        for (Map.Entry&lt;Nonterminal, Set&lt;String&gt;&gt; entry : returns.entrySet())</b>
<b class="fc">&nbsp;            if (!entry.getValue().isEmpty()) {</b>
<b class="fc">&nbsp;                System.out.println(&quot;Returns: &quot; + entry.getKey() + &quot;    &quot; + listToString(entry.getValue(), &quot;;&quot;));</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;        Set&lt;RuntimeRule&gt; newRules = new LinkedHashSet&lt;&gt;();</b>
<b class="fc">&nbsp;        for (Nonterminal nonterminal : grammar.getNonterminals()) {</b>
<b class="fc">&nbsp;            int i = 0;</b>
<b class="fc">&nbsp;            List&lt;Map&lt;Nonterminal, Set&lt;String&gt;&gt;&gt; nonterminal_bindings = bindings.get(nonterminal);</b>
<b class="fc">&nbsp;            for (RuntimeRule rule : grammar.getAlternatives(nonterminal)) {</b>
<b class="fc">&nbsp;                newRules.add(transform(rule,</b>
&nbsp;                                       uses,
<b class="fc">&nbsp;                                       nonterminal_bindings == null ? new HashMap&lt;&gt;() : nonterminal_bindings.get(i++),</b>
&nbsp;                                       returns));
<b class="fc">&nbsp;            }</b>
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;        return RuntimeGrammar.builder()</b>
<b class="fc">&nbsp;                             .addRules(newRules)</b>
<b class="fc">&nbsp;                             .setLayout(grammar.getLayout())</b>
<b class="fc">&nbsp;                             .setStartSymbols(grammar.getStartSymbols())</b>
<b class="fc">&nbsp;                             .setEbnfLefts(grammar.getEBNFLefts())</b>
<b class="fc">&nbsp;                             .setEbnfRights(grammar.getEBNFRights())</b>
<b class="fc">&nbsp;                             .setGlobals(grammar.getGlobals())</b>
<b class="fc">&nbsp;                             .setRegularExpressionDefinitions(grammar.getRegularExpressionDefinitions())</b>
<b class="fc">&nbsp;                             .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private RuntimeRule transform(
&nbsp;            RuntimeRule rule,
&nbsp;            Map&lt;Nonterminal, Set&lt;String&gt;&gt; uses,
&nbsp;            Map&lt;Nonterminal, Set&lt;String&gt;&gt; bindings,
&nbsp;            Map&lt;Nonterminal, Set&lt;String&gt;&gt; returns) {
<b class="fc">&nbsp;        if (rule.getBody() == null) return rule;</b>
&nbsp;
<b class="fc">&nbsp;        Set&lt;String&gt; head_uses = uses.get(rule.getHead());</b>
&nbsp;
<b class="fc">&nbsp;        RuntimeRule.Builder builder = null;</b>
<b class="fc">&nbsp;        if (!head_uses.isEmpty()) {</b>
<b class="fc">&nbsp;            String[] parameters = new String[head_uses.size()];</b>
<b class="fc">&nbsp;            int i = 0;</b>
<b class="fc">&nbsp;            for (String parameter : head_uses)</b>
<b class="fc">&nbsp;                parameters[i++] = parameter;</b>
&nbsp;
<b class="fc">&nbsp;            builder = rule.copyBuilderButWithHead(rule.getHead().copy().addParameters(parameters).build());</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (builder == null) builder = rule.copy();</b>
&nbsp;
<b class="fc">&nbsp;        List&lt;Symbol&gt; symbols = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;        builder = builder.setSymbols(symbols);</b>
&nbsp;
<b class="fc">&nbsp;        DesugarStateVisitor visitor = new DesugarStateVisitor(uses, returns, bindings, grammar);</b>
&nbsp;
<b class="fc">&nbsp;        Return rsym = null;</b>
<b class="fc">&nbsp;        for (Symbol symbol : rule.getBody()) {</b>
<b class="fc">&nbsp;            if (symbol instanceof Return) rsym = (Return) symbol;</b>
<b class="fc">&nbsp;            else symbols.add(symbol.accept(visitor));</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="fc">&nbsp;        Set&lt;String&gt; rets = returns.get(rule.getHead());</b>
&nbsp;
<b class="fc">&nbsp;        if (rets != null &amp;&amp; !rets.isEmpty()) {</b>
&nbsp;            Expression[] exps;
<b class="fc">&nbsp;            int i = 0;</b>
<b class="fc">&nbsp;            if (rsym != null) {</b>
<b class="fc">&nbsp;                exps = new Expression[rets.size() + 1];</b>
<b class="fc">&nbsp;                exps[i++] = rsym.getExpression();</b>
&nbsp;            } else {
<b class="fc">&nbsp;                exps = new Expression[rets.size()];</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            for (String ret : rets)</b>
<b class="fc">&nbsp;                exps[i++] = AST.var(ret);</b>
&nbsp;
<b class="fc">&nbsp;            symbols.add(Return.ret(AST.tuple(exps)));</b>
<b class="fc">&nbsp;        } else {</b>
<b class="fc">&nbsp;            if (rsym != null) symbols.add(rsym);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static class DesugarStateVisitor implements ISymbolVisitor&lt;Symbol&gt; {
&nbsp;
&nbsp;        private final Map&lt;Nonterminal, Set&lt;String&gt;&gt; uses;
&nbsp;        private final Map&lt;Nonterminal, Set&lt;String&gt;&gt; returns;
&nbsp;        private final Map&lt;Nonterminal, Set&lt;String&gt;&gt; bindings;
&nbsp;        private final RuntimeGrammar grammar;
&nbsp;
&nbsp;        DesugarStateVisitor(
&nbsp;                Map&lt;Nonterminal, Set&lt;String&gt;&gt; uses,
&nbsp;                Map&lt;Nonterminal, Set&lt;String&gt;&gt; returns,
&nbsp;                Map&lt;Nonterminal, Set&lt;String&gt;&gt; bindings,
<b class="fc">&nbsp;                RuntimeGrammar grammar) {</b>
<b class="fc">&nbsp;            this.uses = uses;</b>
<b class="fc">&nbsp;            this.returns = returns;</b>
<b class="fc">&nbsp;            this.bindings = bindings;</b>
<b class="fc">&nbsp;            this.grammar = grammar;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Align symbol) {
<b class="nc">&nbsp;            Symbol sym = symbol.getSymbol().accept(this);</b>
<b class="nc">&nbsp;            if (sym == symbol.getSymbol()) return symbol;</b>
<b class="nc">&nbsp;            return new Align.Builder(sym).setLabel(symbol.getLabel()).addConditions(symbol).build();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Block symbol) {
<b class="nc">&nbsp;            throw new UnexpectedSymbolException(symbol, &quot;desugar-state&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Code symbol) {
<b class="fc">&nbsp;            Symbol sym = symbol.getSymbol().accept(this);</b>
<b class="fc">&nbsp;            if (sym == symbol.getSymbol()) return symbol;</b>
&nbsp;
<b class="fc">&nbsp;            return new Code.Builder(sym, symbol.getStatements())</b>
<b class="fc">&nbsp;                    .setLabel(symbol.getLabel())</b>
<b class="fc">&nbsp;                    .addConditions(symbol)</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Error error) {
<b class="fc">&nbsp;            return error;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Conditional symbol) {
<b class="nc">&nbsp;            Symbol sym = symbol.getSymbol().accept(this);</b>
<b class="nc">&nbsp;            if (sym == symbol.getSymbol()) return symbol;</b>
<b class="nc">&nbsp;            return new Conditional.Builder(sym, symbol.getExpression())</b>
<b class="nc">&nbsp;                    .setLabel(symbol.getLabel())</b>
<b class="nc">&nbsp;                    .addConditions(symbol)</b>
<b class="nc">&nbsp;                    .build();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(IfThen symbol) {
<b class="nc">&nbsp;            throw new UnexpectedSymbolException(symbol, &quot;desugar-state&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(IfThenElse symbol) {
<b class="nc">&nbsp;            throw new UnexpectedSymbolException(symbol, &quot;desugar-state&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Ignore symbol) {
<b class="nc">&nbsp;            Symbol sym = symbol.getSymbol().accept(this);</b>
<b class="nc">&nbsp;            if (sym == symbol.getSymbol()) return symbol;</b>
<b class="nc">&nbsp;            return new Ignore.Builder(sym).setLabel(symbol.getLabel()).addConditions(symbol).build();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Nonterminal symbol) {
&nbsp;
<b class="fc">&nbsp;            Builder builder = symbol.copy();</b>
&nbsp;
<b class="fc">&nbsp;            boolean changed = false;</b>
&nbsp;
<b class="fc">&nbsp;            Set&lt;String&gt; pass = uses.get(symbol);</b>
&nbsp;
<b class="fc">&nbsp;            if (pass != null &amp;&amp; !pass.isEmpty()) {</b>
&nbsp;
<b class="fc">&nbsp;                Expression[] arguments = new Expression[pass.size()];</b>
<b class="fc">&nbsp;                int i = 0;</b>
<b class="fc">&nbsp;                for (String argument : pass)</b>
<b class="fc">&nbsp;                    arguments[i++] = AST.var(argument);</b>
&nbsp;
<b class="fc">&nbsp;                builder.apply(arguments);</b>
<b class="fc">&nbsp;                changed = true;</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            Set&lt;String&gt; bind = bindings.get(symbol);</b>
&nbsp;
<b class="fc">&nbsp;            if (bind != null) {</b>
<b class="fc">&nbsp;                Set&lt;String&gt; state = new LinkedHashSet&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;                Set&lt;String&gt; stateReturn = returns.get(symbol);</b>
<b class="fc">&nbsp;                if (stateReturn.size() &gt; 0) {</b>
&nbsp;                    // We should put _ as placeholders for other values returned by the nonterminal.
&nbsp;                    // This is particularly visible in mixing state threading and operator precedence.
&nbsp;                    // As operator precedence adds a return value, and that return value should be ignored here.
&nbsp;                    // See state/Test4 and state/Test5 for examples.
<b class="fc">&nbsp;                    int count = getReturnSize(symbol) - (symbol.getVariable() == null ? 0 : 1);</b>
<b class="fc">&nbsp;                    for (int i = 0; i &lt; count; i++) {</b>
<b class="fc">&nbsp;                        state.add(&quot;_&quot;);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;
<b class="fc">&nbsp;                for (String ret : stateReturn) {</b>
<b class="fc">&nbsp;                    if (bind.contains(ret)) state.add(ret);</b>
<b class="fc">&nbsp;                    else state.add(&quot;_&quot;);</b>
<b class="fc">&nbsp;                }</b>
&nbsp;
<b class="fc">&nbsp;                if (!state.isEmpty()) {</b>
<b class="fc">&nbsp;                    builder.setState(state);</b>
<b class="fc">&nbsp;                    changed = true;</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            return changed ? builder.build() : symbol;</b>
&nbsp;        }
&nbsp;
&nbsp;        // Returns 1 if the grammar already returns a value
&nbsp;        private int getReturnSize(Nonterminal symbol) {
<b class="fc">&nbsp;            List&lt;RuntimeRule&gt; runtimeRules = grammar.getAlternatives(symbol);</b>
<b class="fc">&nbsp;            if (runtimeRules.isEmpty() || runtimeRules.get(0).size() == 0) {</b>
<b class="nc">&nbsp;                return 0;</b>
&nbsp;            }
<b class="fc">&nbsp;            Symbol lastSymbol = runtimeRules.get(0).getLastSymbol();</b>
<b class="fc">&nbsp;            if (lastSymbol instanceof Return) {</b>
<b class="fc">&nbsp;                return 1;</b>
&nbsp;            }
<b class="fc">&nbsp;            return 0;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Offside symbol) {
<b class="nc">&nbsp;            Symbol sym = symbol.getSymbol().accept(this);</b>
<b class="nc">&nbsp;            if (sym == symbol.getSymbol()) return symbol;</b>
<b class="nc">&nbsp;            return new Offside.Builder(sym).setLabel(symbol.getLabel()).addConditions(symbol).build();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Terminal symbol) {
<b class="fc">&nbsp;            return symbol;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(While symbol) {
<b class="nc">&nbsp;            throw new UnexpectedSymbolException(symbol, &quot;desugar-state&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Return symbol) {
<b class="nc">&nbsp;            return symbol;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Alt symbol) {
<b class="nc">&nbsp;            throw new UnexpectedSymbolException(symbol, &quot;desugar-state&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Opt symbol) {
<b class="nc">&nbsp;            throw new UnexpectedSymbolException(symbol, &quot;desugar-state&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Plus symbol) {
<b class="nc">&nbsp;            throw new UnexpectedSymbolException(symbol, &quot;desugar-state&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Group symbol) {
<b class="nc">&nbsp;            throw new UnexpectedSymbolException(symbol, &quot;desugar-state&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Star symbol) {
<b class="nc">&nbsp;            throw new UnexpectedSymbolException(symbol, &quot;desugar-state&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Symbol visit(Start symbol) {
<b class="nc">&nbsp;            throw new UnexpectedSymbolException(symbol, &quot;desugar-state&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-03 17:08</div>
</div>
</body>
</html>
