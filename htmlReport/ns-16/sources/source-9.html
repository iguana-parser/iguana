


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > LayoutWeaver</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.iguana.grammar.transformation</a>
</div>

<h1>Coverage Summary for Class: LayoutWeaver (org.iguana.grammar.transformation)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">LayoutWeaver</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    92.1%
  </span>
  <span class="absValue">
    (58/63)
  </span>
</td>
</tr>
  <tr>
    <td class="name">LayoutWeaver$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (5/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    92.2%
  </span>
  <span class="absValue">
    (59/64)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright (c) 2015, Ali Afroozeh and Anastasia Izmaylova, Centrum Wiskunde &amp; Informatica (CWI)
&nbsp; * All rights reserved.
&nbsp; *
&nbsp; * Redistribution and use in source and binary forms, with or without 
&nbsp; * modification, are permitted provided that the following conditions are met:
&nbsp; *
&nbsp; * 1. Redistributions of source code must retain the above copyright notice, this 
&nbsp; *    list of conditions and the following disclaimer.
&nbsp; *
&nbsp; * 2. Redistributions in binary form must reproduce the above copyright notice, this 
&nbsp; *    list of conditions and the following disclaimer in the documentation and/or 
&nbsp; *    other materials provided with the distribution.
&nbsp; *
&nbsp; * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND 
&nbsp; * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
&nbsp; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
&nbsp; * IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
&nbsp; * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT 
&nbsp; * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, 
&nbsp; * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, 
&nbsp; * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
&nbsp; * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY 
&nbsp; * OF SUCH DAMAGE.
&nbsp; *
&nbsp; */
&nbsp;
&nbsp;package org.iguana.grammar.transformation;
&nbsp;
&nbsp;import org.iguana.grammar.condition.Condition;
&nbsp;import org.iguana.grammar.condition.ConditionType;
&nbsp;import org.iguana.grammar.runtime.RuntimeGrammar;
&nbsp;import org.iguana.grammar.runtime.RuntimeRule;
&nbsp;import org.iguana.grammar.slot.NonterminalNodeType;
&nbsp;import org.iguana.grammar.symbol.Error;
&nbsp;import org.iguana.grammar.symbol.Return;
&nbsp;import org.iguana.grammar.symbol.Symbol;
&nbsp;
&nbsp;import java.util.LinkedHashSet;
&nbsp;import java.util.Set;
&nbsp;
&nbsp;import static org.iguana.grammar.symbol.LayoutStrategy.INHERITED;
&nbsp;
<b class="fc">&nbsp;public class LayoutWeaver implements GrammarTransformation {</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public RuntimeGrammar transform(RuntimeGrammar grammar) {
<b class="fc">&nbsp;        Symbol layout = grammar.getLayout();</b>
&nbsp;
<b class="fc">&nbsp;        RuntimeGrammar.Builder builder = RuntimeGrammar.builder().setLayout(layout).setStartSymbols(</b>
<b class="fc">&nbsp;            grammar.getStartSymbols());</b>
&nbsp;
<b class="fc">&nbsp;        for (RuntimeRule rule : grammar.getRules()) {</b>
<b class="fc">&nbsp;            RuntimeRule.Builder ruleBuilder = RuntimeRule.withHead(rule.getHead())</b>
<b class="fc">&nbsp;                                                .setRecursion(rule.getRecursion())</b>
<b class="fc">&nbsp;                                                .setAssociativity(rule.getAssociativity())</b>
<b class="fc">&nbsp;                                                .setAssociativityGroup(rule.getAssociativityGroup())</b>
<b class="fc">&nbsp;                                                .setPrecedence(rule.getPrecedence())</b>
<b class="fc">&nbsp;                                                .setPrecedenceLevel(rule.getPrecedenceLevel())</b>
<b class="fc">&nbsp;                                                .setLabel(rule.getLabel())</b>
<b class="fc">&nbsp;                                                .setAttributes(rule.getAttributes())</b>
<b class="fc">&nbsp;                                                .setDefinition(rule.getDefinition());</b>
&nbsp;
<b class="fc">&nbsp;            if (rule.size() == 0) {</b>
<b class="fc">&nbsp;                builder.addRule(ruleBuilder.build());</b>
<b class="fc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            if (rule.getHead().getNodeType() == NonterminalNodeType.Start) {</b>
<b class="fc">&nbsp;                if (layout == null) {</b>
<b class="fc">&nbsp;                    builder.addRule(ruleBuilder.addSymbol(rule.symbolAt(0)).build());</b>
&nbsp;                } else {
<b class="fc">&nbsp;                    builder.addRule(ruleBuilder.addSymbol(layout).addSymbol(rule.symbolAt(0)).addSymbol(layout)</b>
<b class="fc">&nbsp;                        .build());</b>
&nbsp;                }
<b class="fc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            for (int i = 0; i &lt; rule.size() - 1; i++) {</b>
<b class="fc">&nbsp;                Symbol s = rule.symbolAt(i);</b>
&nbsp;
<b class="fc">&nbsp;                Set&lt;Condition&gt; ignoreLayoutConditions = getIgnoreLayoutConditions(s);</b>
&nbsp;
<b class="fc">&nbsp;                if (i == rule.size() - 2 &amp;&amp; rule.symbolAt(rule.size() - 1) instanceof Return</b>
<b class="fc">&nbsp;                        &amp;&amp; ignoreLayoutConditions.isEmpty()) {</b>
<b class="fc">&nbsp;                    ruleBuilder.addSymbol(s);</b>
<b class="fc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
<b class="fc">&nbsp;                if (ignoreLayoutConditions.isEmpty())</b>
<b class="fc">&nbsp;                    ruleBuilder.addSymbol(s);</b>
&nbsp;                else
<b class="nc">&nbsp;                    ruleBuilder.addSymbol(s.copy().removePostConditions(ignoreLayoutConditions).build());</b>
&nbsp;
&nbsp;                // Do not insert layout after the layout symbol because we rely on the first set of the next
&nbsp;                // non-layout symbol for synchronization.
<b class="fc">&nbsp;                if (!(s instanceof Error)) {</b>
<b class="fc">&nbsp;                    addLayout(layout, rule, ruleBuilder, s);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            Symbol last = rule.symbolAt(rule.size() - 1);</b>
<b class="fc">&nbsp;            Set&lt;Condition&gt; ignoreLayoutConditions = getIgnoreLayoutConditions(last);</b>
&nbsp;
<b class="fc">&nbsp;            if (ignoreLayoutConditions.isEmpty())</b>
<b class="fc">&nbsp;                ruleBuilder.addSymbol(last);</b>
&nbsp;            else
<b class="nc">&nbsp;                ruleBuilder.addSymbol(last.copy().removePostConditions(ignoreLayoutConditions).build());</b>
&nbsp;
<b class="fc">&nbsp;            if (!ignoreLayoutConditions.isEmpty()) {</b>
<b class="nc">&nbsp;                addLayout(layout, rule, ruleBuilder, last);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            if (rule.getLayoutStrategy() == INHERITED) {</b>
<b class="fc">&nbsp;                ruleBuilder.setLayout(layout);</b>
&nbsp;            }
<b class="fc">&nbsp;            builder.addRule(ruleBuilder.build());</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="fc">&nbsp;        builder.setGlobals(grammar.getGlobals());</b>
<b class="fc">&nbsp;        builder.setEbnfLefts(grammar.getEBNFLefts());</b>
<b class="fc">&nbsp;        builder.setEbnfRights(grammar.getEBNFRights());</b>
<b class="fc">&nbsp;        builder.setRegularExpressionDefinitions(grammar.getRegularExpressionDefinitions());</b>
<b class="fc">&nbsp;        return builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void addLayout(Symbol layout, RuntimeRule rule, RuntimeRule.Builder ruleBuilder, Symbol s) {
<b class="fc">&nbsp;        switch (rule.getLayoutStrategy()) {</b>
&nbsp;            case NO_LAYOUT:
&nbsp;                // do nothing
<b class="fc">&nbsp;                break;</b>
&nbsp;
&nbsp;            case INHERITED:
<b class="fc">&nbsp;                if (layout != null)</b>
<b class="fc">&nbsp;                    ruleBuilder.addSymbol(layout.copy().addPostConditions(getIgnoreLayoutConditions(s)).build());</b>
&nbsp;                break;
&nbsp;
&nbsp;            case FIXED:
<b class="nc">&nbsp;                ruleBuilder.addSymbol(rule.getLayout().copy().addPostConditions(getIgnoreLayoutConditions(s)).build());</b>
&nbsp;                break;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private Set&lt;Condition&gt; getIgnoreLayoutConditions(Symbol s) {
<b class="fc">&nbsp;        Set&lt;Condition&gt; conditions = new LinkedHashSet&lt;&gt;();</b>
<b class="fc">&nbsp;        for (Condition c : s.getPostConditions()) {</b>
<b class="fc">&nbsp;            if (c.getType() == ConditionType.NOT_FOLLOW_IGNORE_LAYOUT</b>
<b class="fc">&nbsp;                || c.getType() == ConditionType.FOLLOW_IGNORE_LAYOUT) {</b>
<b class="nc">&nbsp;                conditions.add(c);</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;        return conditions;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-03 17:08</div>
</div>
</body>
</html>
